<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TSTS GENESIS v3.2 - Master</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root { --neon-blue: #00f2ff; --neon-green: #39ff14; --neon-red: #ff0055; --dark-bg: #030507; }
        body { background-color: var(--dark-bg); color: #e0faff; font-family: 'Share Tech Mono', monospace; margin: 0; padding: 5px; overflow-x: hidden; }
        #app { border: 2px solid #1a3a4a; border-radius: 12px; padding: 10px; min-height: 94vh; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* 視認性重視のメインモニター */
        .monitor { text-align: center; margin-top: 10px; }
        .label { font-size: 0.9rem; color: #88a; letter-spacing: 2px; text-transform: uppercase; }
        .true-val { font-size: 5.8rem; font-weight: bold; line-height: 1; margin: 5px 0; font-variant-numeric: tabular-nums; }
        #true-h { color: var(--neon-green); text-shadow: 0 0 15px var(--neon-green); }
        #true-x { color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); }
        .sub-data { font-size: 1.1rem; color: #557; margin-bottom: 15px; }

        /* 設定パネル */
        .panel { background: #111; border: 1px solid #2a4a5a; padding: 12px; border-radius: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { font-size: 0.75rem; color: #88a; display: block; margin-bottom: 3px; }
        input { width: 100%; background: #000; border: 1px solid #2a4a5a; color: var(--neon-green); font-size: 1.6rem; padding: 8px; box-sizing: border-box; text-align: center; border-radius: 6px; }
        
        .btn { width: 100%; padding: 22px; font-weight: bold; font-size: 1.5rem; border-radius: 12px; border: none; cursor: pointer; margin-top: 8px; text-transform: uppercase; }
        .btn-se { background: var(--neon-blue); color: #000; }
        .btn-7 { background: #444; color: #fff; }
        .btn-hold { background: var(--neon-red); color: #fff; margin-top: 15px; }
        
        .hidden { display: none !important; }
        #status { text-align: center; color: var(--neon-blue); font-size: 0.8rem; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="monitor">
            <div class="label">True CoG Height (Ground)</div>
            <div id="true-h" class="true-val">0.000</div>
            <div class="sub-data">Relative: <span id="rel-h">0.000</span>m</div>

            <div class="label">True CoG Long (Front Axle)</div>
            <div id="true-x" class="true-val">0.000</div>
            <div class="sub-data">Relative: <span id="rel-x">0.000</span>m</div>
        </div>

        <div id="setup-ui">
            <div class="panel">
                <label>4-DIGIT PASSCODE</label>
                <input type="tel" id="linkID" value="7777" maxlength="4">
                
                <div class="grid" style="margin-top:10px;">
                    <div><label>Mount Z (地上高)</label><input type="number" id="mZ" value="1.75" step="0.01"></div>
                    <div><label>Mount X (F軸~)</label><input type="number" id="mX" value="0.80" step="0.01"></div>
                </div>
                
                <div class="grid">
                    <div><label>Initial Guess H</label><input type="number" id="initH" value="0.50" step="0.01"></div>
                    <div><label>Initial Guess X</label><input type="number" id="initX" value="0.95" step="0.01"></div>
                </div>
            </div>
            <button id="seBtn" class="btn btn-se">1. SE 屋根配信開始</button>
            <button id="sevenBtn" class="btn btn-7">2. 7 室内モニター接続</button>
        </div>

        <button id="holdBtn" class="btn btn-hold hidden">RESULT CAPTURE</button>
        <div id="status">WAITING FOR ACTION...</div>
    </div>

    <script>
        let peer, conn;
        const salt = "tsts-v32-";
        const ui = {
            tH: document.getElementById('true-h'), tX: document.getElementById('true-x'),
            rH: document.getElementById('rel-h'), rX: document.getElementById('rel-x'),
            status: document.getElementById('status'), setup: document.getElementById('setup-ui'),
            hold: document.getElementById('holdBtn')
        };

        // 表示更新ロジック
        function render(h, x, mZ, mX) {
            ui.tH.innerText = (mZ - h).toFixed(3);
            ui.tX.innerText = (mX - x).toFixed(3);
            ui.rH.innerText = h;
            ui.rX.innerText = x;
        }

        // SE (配信側)
        document.getElementById('seBtn').onclick = async () => {
            if (DeviceMotionEvent.requestPermission) await DeviceMotionEvent.requestPermission();
            const id = salt + document.getElementById('linkID').value;
            peer = new Peer(id);
            peer.on('open', () => {
                ui.status.innerText = "STREAMING ACTIVE: " + document.getElementById('linkID').value;
                ui.setup.classList.add('hidden');
                ui.hold.classList.remove('hidden');
                startPhysics();
            });
            peer.on('connection', (c) => { conn = c; ui.status.innerText = "LINKED TO MONITOR"; });
        };

        // 7 (受信側)
        document.getElementById('sevenBtn').onclick = () => {
            peer = new Peer();
            peer.on('open', () => {
                const target = salt + document.getElementById('linkID').value;
                const c = peer.connect(target);
                c.on('open', () => {
                    ui.status.innerText = "CONNECTED TO ROOF SENSOR";
                    ui.setup.classList.add('hidden');
                    ui.hold.classList.remove('hidden');
                });
                c.on('data', (d) => render(d.h, d.x, d.mZ, d.mX));
            });
        };

        function startPhysics() {
            // 仮定点からスタート
            let h = parseFloat(document.getElementById('initH').value);
            let x = parseFloat(document.getElementById('initX').value);
            const alpha = 0.025; // 収束平滑化係数

            window.addEventListener('devicemotion', (e) => {
                const acc = e.accelerationIncludingGravity, rot = e.rotationRate;
                if (!acc || !rot) return;

                const mZ = parseFloat(document.getElementById('mZ').value);
                const mX = parseFloat(document.getElementById('mX').value);
                
                const roll = (rot.alpha || 0) * (Math.PI / 180);
                const pitch = (rot.beta || 0) * (Math.PI / 180);

                // ロールによる高さ算出 (レバー比増幅)
                if (Math.abs(roll) > 0.1) {
                    let dynH = mZ - (Math.abs(acc.y) / (Math.abs(roll) + 0.05)) * 0.12;
                    h += (dynH - h) * alpha;
                }
                // ピッチによる前後位置算出
                if (Math.abs(pitch) > 0.1) {
                    let dynX = mX - (acc.z / (Math.abs(pitch) + 0.05)) * 0.08;
                    x += (dynX - x) * alpha;
                }

                const data = { h: h.toFixed(3), x: x.toFixed(3), mZ: mZ, mX: mX };
                render(data.h, data.x, data.mZ, data.mX);
                if (conn && conn.open) conn.send(data);
            });
        }

        ui.hold.onclick = () => {
            ui.tH.style.color = "white";
            ui.tX.style.color = "white";
            ui.status.innerText = "RESULT CAPTURED (Values Locked)";
            // 実際は色を変えるだけで視覚的にホールドしたことを示す
        };
    </script>
</body>
</html>